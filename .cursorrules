# å¤šAIå¯¹è¯èšåˆå™¨ - å¼€å‘è§„åˆ™å’Œç»éªŒæ€»ç»“

## é¡¹ç›®æ¦‚è¿°
Chromeæµè§ˆå™¨æ‰©å±•ï¼Œå…è®¸ç”¨æˆ·ä»å·²æ‰“å¼€çš„æ ‡ç­¾é¡µä¸­é€‰æ‹©ç½‘ç«™è¿›è¡Œåˆ†å±æ˜¾ç¤ºï¼Œå¹¶æ”¯æŒç»Ÿä¸€è¾“å…¥åŠŸèƒ½ã€‚

## æ ¸å¿ƒæ¶æ„

### 1. ä¸»è¦ç»„ä»¶
- **tab-selector**: ä»å·²æ‰“å¼€æ ‡ç­¾é¡µé€‰æ‹©è¦åˆ†å±çš„ç½‘ç«™
- **split-view**: ä½¿ç”¨iframeåœ¨ä¸€ä¸ªæ ‡ç­¾é¡µå†…åˆ†å±æ˜¾ç¤ºå¤šä¸ªç½‘ç«™
- **selector-config**: å¯è§†åŒ–é…ç½®AIç½‘ç«™çš„è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®é€‰æ‹©å™¨
- **window-manager**: å¤‡ç”¨æ–¹æ¡ˆï¼Œä½¿ç”¨çª—å£APIæ’åˆ—
- **element-picker**: æ³¨å…¥åˆ°ç›®æ ‡ç½‘ç«™çš„å…ƒç´ é€‰æ‹©å·¥å…·

### 2. å…³é”®æŠ€æœ¯
- **declarativeNetRequest API**: ç§»é™¤X-Frame-Optionsé™åˆ¶ï¼Œå®ç°iframeåµŒå…¥
- **postMessage**: è·¨iframeé€šä¿¡ï¼Œå®ç°ç»Ÿä¸€å‘é€
- **chrome.storage.local/sync**: æ•°æ®æŒä¹…åŒ–
- **chrome.tabs API**: è·å–å’Œç®¡ç†æ ‡ç­¾é¡µ
- **Content Scripts**: æ“ä½œç½‘é¡µDOM

## é‡è¦è®¾è®¡å†³ç­–

### 1. å®Œå…¨ç§»é™¤ç¡¬ç¼–ç 
âŒ **é”™è¯¯åšæ³•**ï¼šé¢„è®¾AIç½‘ç«™åˆ—è¡¨
```javascript
const DEFAULT_AI_SITES = [
  { id: 'chatgpt', name: 'ChatGPT', url: 'https://chatgpt.com/' },
  { id: 'gemini', name: 'Gemini', url: 'https://gemini.google.com/' }
];
```

âœ… **æ­£ç¡®åšæ³•**ï¼šä»æ ‡ç­¾é¡µåŠ¨æ€è·å–
```javascript
const tabs = await chrome.tabs.query({});
const validTabs = tabs.filter(tab => 
  tab.url && tab.url.startsWith('http') && 
  !tab.url.includes('chrome://')
);
```

### 2. æ•°æ®ä¼ é€’æœºåˆ¶
**tab-selector â†’ split-view**:
```javascript
// tab-selectorä¿å­˜ä¸´æ—¶æ•°æ®
await chrome.storage.local.set({ 
  selectedSitesForSplit: sites,
  splitViewTimestamp: Date.now()
});

// split-viewè¯»å–ï¼ˆ5ç§’å†…æœ‰æ•ˆï¼‰
if (localResult.selectedSitesForSplit && 
    Date.now() - localResult.splitViewTimestamp < 5000) {
  aiSites = localResult.selectedSitesForSplit;
}
```

### 3. è·¨iframeé€šä¿¡
**çˆ¶é¡µé¢å‘é€**:
```javascript
iframe.contentWindow.postMessage({
  action: 'fillAndSend',
  text: text,
  source: 'ai-aggregator'
}, '*');
```

**iframeå†…éƒ¨æ¥æ”¶** (iframe-injector.js):
```javascript
window.addEventListener('message', (event) => {
  if (event.data.action === 'fillAndSend' && 
      event.data.source === 'ai-aggregator') {
    fillInput(element, event.data.text);
    clickSendButton();
  }
});
```

### 4. äº‹ä»¶é˜»æ­¢ç­–ç•¥
**é€‰æ‹©å…ƒç´ æ—¶é˜²æ­¢è¯¯è§¦å‘**:
```javascript
function handleClick(e) {
  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation(); // å…³é”®ï¼é˜»æ­¢åŒå…ƒç´ çš„å…¶ä»–ç›‘å¬å™¨
}

// å¿…é¡»ç›‘å¬æ‰€æœ‰é¼ æ ‡äº‹ä»¶
document.addEventListener('mousedown', handleMouseDown, true); // captureé˜¶æ®µ
document.addEventListener('mouseup', handleMouseUp, true);
document.addEventListener('click', handleClick, true);
```

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: iframeæ— æ³•åŠ è½½ç½‘ç«™
**åŸå› **: X-Frame-Optionså’ŒCSPé™åˆ¶
**è§£å†³**: ä½¿ç”¨declarativeNetRequest API
```json
// rules.json
{
  "action": {
    "type": "modifyHeaders",
    "responseHeaders": [
      { "header": "x-frame-options", "operation": "remove" },
      { "header": "content-security-policy", "operation": "remove" }
    ]
  },
  "condition": {
    "resourceTypes": ["sub_frame"]
  }
}
```

### é—®é¢˜2: æ— æ³•å‘AIè¾“å…¥æ¡†å¡«å……å†…å®¹
**åŸå› **: 
1. ç½‘ç«™ä½¿ç”¨contentEditableè€Œétextarea
2. ç½‘ç«™ç›‘å¬ç‰¹å®šäº‹ä»¶ï¼ˆä¸åªæ˜¯inputï¼‰
3. åçˆ¬è™«æœºåˆ¶æ£€æµ‹isTrusted

**è§£å†³**: å¤šç§æ–¹æ³•ç»„åˆ
```javascript
// 1. å…ˆèšç„¦
element.focus();
element.click();

// 2. å¤šç§å¡«å……æ–¹å¼
element.value = text; // textarea
element.textContent = text; // contentEditable
element.innerHTML = text;

// 3. è§¦å‘å¤šç§äº‹ä»¶
element.dispatchEvent(new Event('input', { bubbles: true }));
element.dispatchEvent(new InputEvent('input', { inputType: 'insertText' }));
element.dispatchEvent(new Event('keyup', { bubbles: true }));
```

### é—®é¢˜3: é€‰æ‹©å‘é€æŒ‰é’®æ—¶è¯¯è§¦å‘å‘é€
**åŸå› **: ç½‘ç«™ç›‘å¬mousedown/mouseupè€Œéclick
**è§£å†³**: åœ¨æ•è·é˜¶æ®µé˜»æ­¢æ‰€æœ‰é¼ æ ‡äº‹ä»¶
```javascript
document.addEventListener('mousedown', handleMouseDown, true);
document.addEventListener('mouseup', handleMouseUp, true);
document.addEventListener('click', handleClick, true);
```

### é—®é¢˜4: Geminiç­‰ç½‘ç«™ä½¿ç”¨Quillç¼–è¾‘å™¨æ— æ³•è¾“å…¥
**åŸå› **: Quillç¼–è¾‘å™¨æœ‰è‡ªå·±çš„äº‹ä»¶ç³»ç»Ÿ
**è§£å†³**: å°è¯•ç›´æ¥æ“ä½œQuillå®ä¾‹
```javascript
const quillContainer = element.closest('.ql-container');
if (quillContainer && quillContainer.__quill) {
  quillContainer.__quill.setText(text);
}
```

### é—®é¢˜5: split-viewæ˜¾ç¤ºç©ºç™½
**åŸå› **: æ²¡æœ‰æ•°æ®æºï¼ˆåˆ é™¤ç¡¬ç¼–ç åï¼‰
**è§£å†³**: æ˜¾ç¤ºå¼•å¯¼ç•Œé¢
```javascript
if (aiSites.length === 0) {
  showEmptyGuide(); // å¼•å¯¼ç”¨æˆ·ä½¿ç”¨tab-selector
  return;
}
```

## å¼€å‘æœ€ä½³å®è·µ

### 1. è°ƒè¯•ç­–ç•¥
```javascript
// æ·»åŠ è¯¦ç»†çš„console.log
console.log('tab-selector: å‡†å¤‡ä¿å­˜çš„ç½‘ç«™æ•°æ®:', sites);
console.log('split-view: æ—¶é—´å·®:', timeDiff, 'ms');

// åœ¨å…³é”®è·¯å¾„ä¸Šæ£€æŸ¥
if (!element) {
  console.error('æœªæ‰¾åˆ°å…ƒç´ :', selector);
  return;
}
```

### 2. ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
- âœ… ç©ºçŠ¶æ€æ—¶æ˜¾ç¤ºå¼•å¯¼è€Œéç©ºç™½
- âœ… æ“ä½œå¤±è´¥æ—¶ç»™å‡ºæ˜ç¡®æç¤º
- âœ… æä¾›"åˆ·æ–°"æŒ‰é’®è€Œéè¦æ±‚ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°
- âœ… æ˜¾ç¤ºå®æ—¶è®¡æ•°å’ŒçŠ¶æ€

### 3. æ•°æ®å­˜å‚¨
```javascript
// ä¸´æ—¶æ•°æ®ç”¨localï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
chrome.storage.local.set({ 
  data: value,
  timestamp: Date.now()
});

// æŒä¹…é…ç½®ç”¨sync
chrome.storage.sync.set({ 
  aiSites: sites
});
```

### 4. é”™è¯¯å¤„ç†
```javascript
try {
  await someOperation();
} catch (error) {
  console.error('æ“ä½œå¤±è´¥:', error);
  showNotification('æ“ä½œå¤±è´¥: ' + error.message, 'error');
}
```

## åŠŸèƒ½æ¸…å•

### âœ… å·²å®ç°
1. ä»æ ‡ç­¾é¡µåŠ¨æ€é€‰æ‹©ç½‘ç«™ï¼ˆæ— ç¡¬ç¼–ç ï¼‰
2. åœ¨ä¸€ä¸ªæ ‡ç­¾é¡µå†…åˆ†å±æ˜¾ç¤ºï¼ˆä½¿ç”¨iframe + declarativeNetRequestï¼‰
3. ç»Ÿä¸€è¾“å…¥æ¡†å‘æ‰€æœ‰AIå‘é€æ¶ˆæ¯ï¼ˆpostMessage + content scriptï¼‰
4. å¯è§†åŒ–é…ç½®é€‰æ‹©å™¨ï¼ˆelement-pickerï¼‰
5. å¤šç§å¸ƒå±€æ”¯æŒï¼ˆ2åˆ—ã€3åˆ—ã€4å®«æ ¼ç­‰ï¼‰
6. ç©ºçŠ¶æ€å¼•å¯¼
7. å®æ—¶åˆ·æ–°æ ‡ç­¾é¡µåˆ—è¡¨
8. é…ç½®æŒä¹…åŒ–

### ğŸš§ å¾…ä¼˜åŒ–
1. æ”¯æŒiframeå¤§å°è°ƒæ•´
2. æ”¯æŒæ‹–æ‹½æ’åº
3. å†å²å¯¹è¯è®°å½•å¯¹æ¯”
4. å¿«æ·é”®æ”¯æŒ
5. å¯¼å‡ºå¯¹è¯åŠŸèƒ½
6. æ›´æ™ºèƒ½çš„é€‰æ‹©å™¨è‡ªåŠ¨è¯†åˆ«
7. æ”¯æŒæ›´å¤šå¸ƒå±€æ¨¡å¼
8. æ€§èƒ½ä¼˜åŒ–ï¼ˆæ‡’åŠ è½½iframeï¼‰

### âŒ å·²åºŸå¼ƒ
1. ç¡¬ç¼–ç çš„AIç½‘ç«™åˆ—è¡¨
2. è‡ªåŠ¨å¡«å……æµ‹è¯•æ–‡å­—ï¼ˆæ”¹ä¸ºæ‰‹åŠ¨è¾“å…¥ï¼‰
3. å¤æ‚çš„åçˆ¬è™«å¯¹ç­–ï¼ˆä¿æŒç®€å•ï¼‰

## æ–‡ä»¶ç»„ç»‡

```
â”œâ”€â”€ manifest.json           # æ‰©å±•é…ç½®
â”œâ”€â”€ rules.json             # declarativeNetRequestè§„åˆ™
â”œâ”€â”€ config.js              # ç©ºçš„é…ç½®æ–‡ä»¶ï¼ˆå‘åå…¼å®¹ï¼‰
â”œâ”€â”€ background.js          # Service Worker
â”œâ”€â”€ popup/                 # æ‰©å±•å¼¹å‡ºçª—å£
â”œâ”€â”€ tab-selector/          # æ ‡ç­¾é¡µé€‰æ‹©å™¨ï¼ˆä¸»è¦å…¥å£ï¼‰
â”œâ”€â”€ split-view/            # åˆ†å±è§†å›¾ï¼ˆiframeæ–¹å¼ï¼‰
â”œâ”€â”€ selector-config/       # é€‰æ‹©å™¨é…ç½®å‘å¯¼
â”‚   â”œâ”€â”€ element-picker.js  # å…ƒç´ é€‰æ‹©å·¥å…·
â”‚   â””â”€â”€ ...
â”œâ”€â”€ content-scripts/       # å†…å®¹è„šæœ¬
â”‚   â”œâ”€â”€ injector.js        # é€šç”¨æ³¨å…¥è„šæœ¬
â”‚   â””â”€â”€ iframe-injector.js # iframeå†…éƒ¨æ³¨å…¥
â””â”€â”€ window-manager/        # çª—å£ç®¡ç†å™¨ï¼ˆå¤‡ç”¨ï¼‰
```

## æ³¨æ„äº‹é¡¹

1. **ä¸è¦ç¡¬ç¼–ç **ï¼šä»»ä½•ç½‘ç«™åˆ—è¡¨éƒ½åº”è¯¥åŠ¨æ€ç”Ÿæˆ
2. **äº‹ä»¶é˜»æ­¢è¦å½»åº•**ï¼šmousedown/mouseup/clickéƒ½è¦é˜»æ­¢
3. **è·¨iframeé€šä¿¡è¦éªŒè¯æ¥æº**ï¼šæ£€æŸ¥sourceæ ‡è¯†
4. **æ•°æ®ä¼ é€’è¦åŠ æ—¶é—´æˆ³**ï¼šé˜²æ­¢è„æ•°æ®
5. **ç©ºçŠ¶æ€è¦å‹å¥½**ï¼šå¼•å¯¼ç”¨æˆ·è€Œéæ˜¾ç¤ºç©ºç™½
6. **è°ƒè¯•æ—¥å¿—è¦è¯¦ç»†**ï¼šå…³é”®è·¯å¾„å¿…é¡»æœ‰æ—¥å¿—
7. **ç”¨æˆ·æ“ä½œè¦æœ‰åé¦ˆ**ï¼šåŠ è½½ä¸­/æˆåŠŸ/å¤±è´¥éƒ½è¦æç¤º

## manifest.json å…³é”®é…ç½®

```json
{
  "permissions": [
    "storage",
    "tabs",
    "scripting",
    "declarativeNetRequest",
    "declarativeNetRequestWithHostAccess"
  ],
  "declarative_net_request": {
    "rule_resources": [{
      "id": "remove_headers",
      "enabled": true,
      "path": "rules.json"
    }]
  },
  "content_scripts": [{
    "matches": ["<all_urls>"],
    "js": ["content-scripts/iframe-injector.js"],
    "all_frames": true  // å…³é”®ï¼è®©è„šæœ¬åœ¨iframeä¸­è¿è¡Œ
  }]
}
```

## æ€»ç»“ç»éªŒ

### æŠ€æœ¯çªç ´
1. ä½¿ç”¨declarativeNetRequestç»•è¿‡X-Frame-Optionsæ˜¯å…³é”®çªç ´
2. postMessage + content scriptå®ç°è·¨iframeé€šä¿¡
3. æ—¶é—´æˆ³éªŒè¯ç¡®ä¿æ•°æ®æ–°é²œåº¦

### ç”¨æˆ·ä½“éªŒ
1. ä»æ ‡ç­¾é¡µé€‰æ‹©æ¯”ç¡¬ç¼–ç æ›´çµæ´»
2. å¯è§†åŒ–å…ƒç´ é€‰æ‹©æ¯”æ‰‹å†™CSSé€‰æ‹©å™¨æ›´å‹å¥½
3. ç©ºçŠ¶æ€å¼•å¯¼æ¯”ç©ºç™½é¡µé¢æ›´å¥½

### é¿å…çš„å‘
1. ä¸è¦ä¾èµ–è‡ªåŠ¨å¡«å……ï¼ˆå¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥æ›´å¯é ï¼‰
2. ä¸è¦åªé˜»æ­¢clickï¼ˆè¦é˜»æ­¢mousedown/mouseupï¼‰
3. ä¸è¦ä½¿ç”¨ç¡¬ç¼–ç ï¼ˆå®Œå…¨åŠ¨æ€åŒ–ï¼‰
4. ä¸è¦å¿˜è®°æ¸…ç†ä¸´æ—¶æ•°æ®ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰

---
æœ€åæ›´æ–°: 2025-10-15
ç‰ˆæœ¬: 1.0.0

