# é¢„è®¾é…ç½®é•¿æœŸä¼˜åŒ–è®¡åˆ’

## å½“å‰å®ç°çŠ¶æ€ï¼ˆv1.0ï¼‰

### âœ… å·²å®ç°
- **ç”¨æˆ·é…ç½®ä¼˜å…ˆç­–ç•¥**ï¼šç”¨æˆ·è‡ªå®šä¹‰é…ç½®å§‹ç»ˆä¼˜å…ˆäºé¢„è®¾é…ç½®
- **é¢„è®¾é…ç½®æ–‡ä»¶**ï¼š`default-configs.js` åŒ…å«ä¸»æµAIç½‘ç«™çš„é¢„è®¾é€‰æ‹©å™¨
- **é…ç½®æ¥æºæ ‡è¯†**ï¼šç•Œé¢æ¸…æ™°æ˜¾ç¤º"âœï¸ è‡ªå®šä¹‰"æˆ–"âš™ï¸ é¢„è®¾"
- **é‡ç½®ä¸ºé¢„è®¾åŠŸèƒ½**ï¼šç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå®šä¹‰é…ç½®ï¼Œæ¢å¤ä½¿ç”¨é¢„è®¾
- **åŠ¨æ€åˆå¹¶æœºåˆ¶**ï¼šè¿è¡Œæ—¶ä»ç”¨æˆ·é…ç½®å’Œé¢„è®¾é…ç½®ä¸­åŠ¨æ€åˆå¹¶

### å·¥ä½œæµç¨‹
```
ç”¨æˆ·è®¿é—®ç½‘ç«™
  â†“
1. è¯»å–ç”¨æˆ·è‡ªå®šä¹‰é…ç½® (chrome.storage.local)
2. è¯»å–é¢„è®¾é…ç½® (default-configs.js)
3. åˆå¹¶ç­–ç•¥ï¼š
   - æœ‰ç”¨æˆ·é…ç½® â†’ ä½¿ç”¨ç”¨æˆ·é…ç½® âœ…
   - æ— ç”¨æˆ·é…ç½®ï¼Œæœ‰é¢„è®¾ â†’ ä½¿ç”¨é¢„è®¾ âœ…
   - éƒ½æ²¡æœ‰ â†’ ä½¿ç”¨é€šç”¨é€‰æ‹©å™¨ âœ…
```

## é•¿æœŸä¼˜åŒ–æ–¹å‘ï¼ˆv2.0+ï¼‰

### 1. åˆ†å±‚ç­–ç•¥ - ç‰ˆæœ¬æ¯”è¾ƒä¸ä¸»åŠ¨é€šçŸ¥

#### ç›®æ ‡
å½“é¢„è®¾é…ç½®æ›´æ–°æ—¶ï¼Œä¸»åŠ¨é€šçŸ¥ç”¨æˆ·æœ‰æ›´å¥½çš„é…ç½®å¯ç”¨ã€‚

#### è®¾è®¡æ–¹æ¡ˆ

##### 1.1 ç‰ˆæœ¬è·Ÿè¸ª
```javascript
// default-configs.js - é¢„è®¾é…ç½®å¢åŠ ç‰ˆæœ¬å·
const DEFAULT_CONFIGS = {
  'chat_deepseek_com': {
    inputSelector: 'textarea',
    sendButtonSelector: 'button[type="submit"]',
    version: '2025-01-19',  // é…ç½®ç‰ˆæœ¬
    changeLog: 'Initial version' // å˜æ›´è¯´æ˜
  }
};

// ç”¨æˆ·é…ç½®ä¹Ÿè®°å½•ç‰ˆæœ¬
userConfigs['chat_deepseek_com'] = {
  inputSelector: 'textarea.custom',
  sendButtonSelector: 'button.send',
  version: '2025-01-10',  // ç”¨æˆ·é…ç½®æ—¶é—´
  source: 'user',
  basedOnPresetVersion: '2025-01-05'  // åŸºäºå“ªä¸ªé¢„è®¾ç‰ˆæœ¬
};
```

##### 1.2 ç‰ˆæœ¬æ¯”è¾ƒé€»è¾‘
```javascript
async function loadSiteConfig() {
  const userConfig = userConfigs[siteId];
  const presetConfig = DEFAULT_CONFIGS[siteId];
  
  if (userConfig && presetConfig) {
    // æ¯”è¾ƒç‰ˆæœ¬
    const presetDate = new Date(presetConfig.version);
    const userDate = new Date(userConfig.basedOnPresetVersion || userConfig.version);
    
    if (presetDate > userDate) {
      // é¢„è®¾é…ç½®æ›´æ–°äº†ï¼
      await notifyConfigUpdate(siteId, {
        currentConfig: userConfig,
        newPresetConfig: presetConfig,
        improvements: presetConfig.changeLog
      });
    }
  }
  
  // ç»§ç»­ä½¿ç”¨ç”¨æˆ·é…ç½®ï¼ˆä¸å¼ºåˆ¶æ›´æ–°ï¼‰
  return userConfig || presetConfig;
}
```

##### 1.3 é€šçŸ¥æœºåˆ¶
```javascript
// åœ¨split-viewæˆ–é…ç½®é¡µé¢æ˜¾ç¤ºé€šçŸ¥æ¨ªå¹…
async function notifyConfigUpdate(siteId, { currentConfig, newPresetConfig, improvements }) {
  const notification = {
    type: 'config-update',
    siteId: siteId,
    siteName: newPresetConfig.name,
    currentVersion: currentConfig.version,
    newVersion: newPresetConfig.version,
    improvements: improvements,
    timestamp: Date.now()
  };
  
  // å­˜å‚¨åˆ°å¾…å¤„ç†é€šçŸ¥åˆ—è¡¨
  await chrome.storage.local.set({
    pendingConfigUpdates: [notification]
  });
  
  // åœ¨é…ç½®é¡µé¢æ˜¾ç¤ºé€šçŸ¥æ¨ªå¹…
  showUpdateBanner(notification);
}

function showUpdateBanner(notification) {
  const banner = document.createElement('div');
  banner.className = 'config-update-banner';
  banner.innerHTML = `
    <div class="banner-icon">ğŸ†•</div>
    <div class="banner-content">
      <h4>${notification.siteName} æœ‰æ–°çš„æ¨èé…ç½®</h4>
      <p>ç‰ˆæœ¬: ${notification.currentVersion} â†’ ${notification.newVersion}</p>
      <p>æ”¹è¿›: ${notification.improvements}</p>
    </div>
    <div class="banner-actions">
      <button class="btn-view-diff">æŸ¥çœ‹å·®å¼‚</button>
      <button class="btn-apply-preset">åº”ç”¨æ–°é¢„è®¾</button>
      <button class="btn-keep-current">ä¿æŒç°æœ‰</button>
    </div>
  `;
  
  document.body.prepend(banner);
}
```

##### 1.4 åº”ç”¨æ›´æ–°
```javascript
async function applyPresetUpdate(siteId) {
  const presetConfig = DEFAULT_CONFIGS[siteId];
  
  // å¤‡ä»½ç”¨æˆ·é…ç½®
  const backup = { ...userConfigs[siteId] };
  await chrome.storage.local.set({
    [`configBackup_${siteId}`]: backup
  });
  
  // åº”ç”¨é¢„è®¾é…ç½®
  userConfigs[siteId] = {
    ...presetConfig,
    source: 'preset-applied',
    appliedAt: Date.now(),
    previousUserConfig: backup
  };
  
  await saveConfigs();
  
  // æ˜¾ç¤ºæˆåŠŸæç¤º
  showNotification('âœ… å·²åº”ç”¨æ–°é¢„è®¾é…ç½®', 'success');
}
```

### 2. å­—æ®µçº§åˆå¹¶

#### ç›®æ ‡
ç”¨æˆ·åªé…ç½®éƒ¨åˆ†å­—æ®µï¼ˆå¦‚è¾“å…¥æ¡†ï¼‰ï¼Œå…¶ä»–å­—æ®µï¼ˆå¦‚å‘é€æŒ‰é’®ï¼‰è‡ªåŠ¨ä½¿ç”¨é¢„è®¾ã€‚

#### å®ç°æ–¹æ¡ˆ
```javascript
function getSiteConfig(siteId) {
  const userConfig = userConfigs[siteId];
  const presetConfig = DEFAULT_CONFIGS[siteId];
  
  if (!userConfig) return presetConfig;
  if (!presetConfig) return userConfig;
  
  // å­—æ®µçº§åˆå¹¶
  return {
    // è¾“å…¥æ¡†ï¼šç”¨æˆ·é…ç½®ä¼˜å…ˆ
    inputSelector: userConfig.inputSelector || presetConfig.inputSelector,
    inputSelectorSource: userConfig.inputSelector ? 'user' : 'preset',
    
    // å‘é€æŒ‰é’®ï¼šç”¨æˆ·é…ç½®ä¼˜å…ˆ
    sendButtonSelector: userConfig.sendButtonSelector || presetConfig.sendButtonSelector,
    sendButtonSelectorSource: userConfig.sendButtonSelector ? 'user' : 'preset',
    
    // å…ƒæ•°æ®
    version: userConfig.version,
    presetVersion: presetConfig.version,
    source: 'merged'
  };
}
```

#### é…ç½®ç•Œé¢å±•ç¤º
```javascript
// åœ¨é…ç½®é¡µé¢æ˜¾ç¤ºè¯¦ç»†æ¥æº
<div class="config-detail">
  <div class="config-field">
    <label>è¾“å…¥æ¡†é€‰æ‹©å™¨</label>
    <code>${config.inputSelector}</code>
    <span class="source-badge ${config.inputSelectorSource}">
      ${config.inputSelectorSource === 'user' ? 'è‡ªå®šä¹‰' : 'é¢„è®¾'}
    </span>
  </div>
  
  <div class="config-field">
    <label>å‘é€æŒ‰é’®é€‰æ‹©å™¨</label>
    <code>${config.sendButtonSelector}</code>
    <span class="source-badge ${config.sendButtonSelectorSource}">
      ${config.sendButtonSelectorSource === 'user' ? 'è‡ªå®šä¹‰' : 'é¢„è®¾'}
    </span>
  </div>
</div>
```

### 3. æ™ºèƒ½é…ç½®éªŒè¯

#### ç›®æ ‡
å®šæœŸéªŒè¯é…ç½®æ˜¯å¦æœ‰æ•ˆï¼Œå¤±æ•ˆæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„è®¾æˆ–é€šçŸ¥ç”¨æˆ·ã€‚

#### å®ç°æ–¹æ¡ˆ
```javascript
// åœ¨iframe-injector.jsä¸­éªŒè¯é…ç½®
async function validateConfig(siteConfig) {
  const inputElement = document.querySelector(siteConfig.inputSelector);
  const sendButton = document.querySelector(siteConfig.sendButtonSelector);
  
  const isValid = !!(inputElement && sendButton && 
                     isVisible(inputElement) && isVisible(sendButton));
  
  if (!isValid) {
    console.warn('âš ï¸ é…ç½®éªŒè¯å¤±è´¥ï¼Œé€‰æ‹©å™¨å¯èƒ½å·²å¤±æ•ˆ');
    
    // è®°å½•å¤±è´¥
    await chrome.storage.local.set({
      [`configValidation_${siteId}`]: {
        isValid: false,
        lastChecked: Date.now(),
        failureCount: (previousFailureCount || 0) + 1
      }
    });
    
    // å¦‚æœå¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œé€šçŸ¥ç”¨æˆ·
    if (failureCount >= 3) {
      notifyConfigFailure(siteId);
    }
  }
  
  return isValid;
}
```

### 4. äº‘ç«¯é…ç½®åŒæ­¥ï¼ˆå¯é€‰ï¼‰

#### ç›®æ ‡
ç”¨æˆ·åœ¨ä¸åŒè®¾å¤‡é—´åŒæ­¥é…ç½®ï¼Œå¹¶ä¸”è·å–ç¤¾åŒºç»´æŠ¤çš„æœ€æ–°é…ç½®ã€‚

#### å®ç°æ–¹æ¡ˆ
```javascript
// ä½¿ç”¨chrome.storage.syncè‡ªåŠ¨åŒæ­¥
await chrome.storage.sync.set({
  userConfigs: allConfigs
});

// æˆ–è€…å»ºç«‹äº‘ç«¯é…ç½®æœåŠ¡å™¨
async function fetchLatestPresets() {
  const response = await fetch('https://api.example.com/presets/latest');
  const cloudPresets = await response.json();
  
  // åˆå¹¶äº‘ç«¯é¢„è®¾å’Œæœ¬åœ°é¢„è®¾
  return { ...DEFAULT_CONFIGS, ...cloudPresets };
}
```

## å®æ–½ä¼˜å…ˆçº§

### P0 - å½“å‰ç‰ˆæœ¬ï¼ˆå·²å®Œæˆï¼‰
- âœ… åŸºç¡€é¢„è®¾é…ç½®æ–‡ä»¶
- âœ… ç”¨æˆ·é…ç½®ä¼˜å…ˆç­–ç•¥
- âœ… é…ç½®æ¥æºæ ‡è¯†
- âœ… é‡ç½®ä¸ºé¢„è®¾åŠŸèƒ½

### P1 - ä¸‹ä¸ªç‰ˆæœ¬ï¼ˆv2.0ï¼‰
- ğŸ”œ ç‰ˆæœ¬æ¯”è¾ƒæœºåˆ¶
- ğŸ”œ é…ç½®æ›´æ–°é€šçŸ¥
- ğŸ”œ å­—æ®µçº§åˆå¹¶

### P2 - æœªæ¥ç‰ˆæœ¬ï¼ˆv3.0ï¼‰
- ğŸ“‹ æ™ºèƒ½é…ç½®éªŒè¯
- ğŸ“‹ é…ç½®å¤‡ä»½å’Œæ¢å¤
- ğŸ“‹ å·®å¼‚å¯¹æ¯”ç•Œé¢

### P3 - é•¿è¿œè§„åˆ’
- ğŸ“‹ äº‘ç«¯é…ç½®åŒæ­¥
- ğŸ“‹ ç¤¾åŒºé…ç½®åˆ†äº«
- ğŸ“‹ é…ç½®è‡ªåŠ¨ä¿®å¤

## æŠ€æœ¯å€ºåŠ¡å’Œæ³¨æ„äº‹é¡¹

### æ•°æ®è¿ç§»
å¦‚æœæ›´æ”¹é…ç½®ç»“æ„ï¼Œéœ€è¦æä¾›è¿ç§»è„šæœ¬ï¼š
```javascript
async function migrateConfigs() {
  const oldConfigs = await chrome.storage.local.get(['aiSelectorConfigs']);
  
  const newConfigs = {};
  for (const [id, config] of Object.entries(oldConfigs.aiSelectorConfigs || {})) {
    newConfigs[id] = {
      ...config,
      version: config.version || '2025-01-01',  // æ·»åŠ é»˜è®¤ç‰ˆæœ¬
      source: config.source || 'user'
    };
  }
  
  await chrome.storage.local.set({ aiSelectorConfigs: newConfigs });
}
```

### æ€§èƒ½è€ƒè™‘
- ç‰ˆæœ¬æ¯”è¾ƒä¸è¦åœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶éƒ½æ‰§è¡Œï¼Œä½¿ç”¨ç¼“å­˜
- é€šçŸ¥ä¸è¦è¿‡äºé¢‘ç¹ï¼Œè®¾ç½®å†·é™æœŸï¼ˆå¦‚7å¤©å†…ä¸é‡å¤é€šçŸ¥ï¼‰

### ç”¨æˆ·ä½“éªŒ
- é€šçŸ¥è¦å‹å¥½ï¼Œä¸è¦å¼ºåˆ¶ç”¨æˆ·æ›´æ–°
- æä¾›"ä¸å†æç¤º"é€‰é¡¹
- å·®å¼‚å¯¹æ¯”è¦ç›´è§‚ï¼Œä½¿ç”¨å¯è§†åŒ–ç•Œé¢

## å‚è€ƒèµ„æ–™

- Chrome Extension Storage API: https://developer.chrome.com/docs/extensions/reference/storage/
- Semantic Versioning: https://semver.org/
- é…ç½®ç®¡ç†æœ€ä½³å®è·µ: https://12factor.net/config

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-19  
**è´Ÿè´£äºº**: å¾…å®š  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸

