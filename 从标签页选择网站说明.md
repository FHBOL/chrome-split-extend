# 📑 从标签页选择网站 - 功能说明

## 🎯 改进目标

**问题**：之前硬编码了预设的AI网站列表（ChatGPT、Gemini、Claude等），不够灵活

**解决方案**：改为从用户已打开的浏览器标签页中动态获取网站列表，用户可以配置**任意**网站

## ✅ 实现的功能

### 1. 动态获取标签页

**技术实现**：
```javascript
// 获取所有标签页
const tabs = await chrome.tabs.query({});

// 过滤有效的网站（排除扩展页面、chrome://等）
const validTabs = tabs.filter(tab => 
  tab.url && 
  (tab.url.startsWith('http://') || tab.url.startsWith('https://')) &&
  !tab.url.includes('chrome://') &&
  !tab.url.includes('chrome-extension://')
);
```

### 2. 智能网站识别

**域名提取**：
- 使用`new URL(tab.url)`解析URL
- 提取`hostname`作为网站唯一标识
- 网站名称使用标签页标题`tab.title`

**唯一ID生成**：
```javascript
// 基于hostname生成ID（替换特殊字符为下划线）
const siteId = hostname.replace(/[^a-zA-Z0-9]/g, '_');
// 例如：chat.openai.com → chat_openai_com
```

### 3. 智能图标匹配

**内置图标库**：
```javascript
const iconMap = {
  'chatgpt.com': '💬',
  'gemini.google.com': '🌟',
  'claude.ai': '🧠',
  'chat.deepseek.com': '🔍',
  'kimi.moonshot.cn': '🌙',
  'chat.qwen.ai': '🎯',
  'poe.com': '🤖',
  'perplexity.ai': '🔮',
  'you.com': '🔎'
};
```

**匹配策略**：
1. 精确匹配域名
2. 部分匹配（包含关系）
3. 默认使用🌐图标

### 4. 配置状态显示

每个网站卡片显示：
- ✅ **图标**：智能识别的emoji图标
- ✅ **网站名称**：标签页标题
- ✅ **URL**：网站域名
- ✅ **配置状态**："✓ 已配置" 或 "待配置"

### 5. 空状态处理

**没有打开标签页时**：
```
📭
没有找到可配置的网站
请先在浏览器中打开你想配置的AI网站，然后刷新此页面
[🔄 刷新标签页列表]
```

### 6. 实时刷新

- 顶部"🔄 刷新列表"按钮
- 点击后重新获取最新的标签页列表
- 支持用户打开新标签页后刷新

## 🎨 界面优化

### 1. 卡片布局改进

**从**：垂直居中布局
```css
.ai-card {
  text-align: center;
}
```

**改为**：水平flexbox布局
```css
.ai-card {
  display: flex;
  align-items: center;
  gap: 16px;
}
```

**效果**：
```
┌────────────────────────────────────┐
│ 💬  ChatGPT                    ✓  │
│     https://chatgpt.com      已配置│
└────────────────────────────────────┘
```

### 2. 新增样式

- **`.step-header`**：步骤标题和刷新按钮的flex布局
- **`.hint-text`**：黄色提示框
- **`.ai-info`**：网站信息容器
- **`.empty-state`**：空状态样式
- **`.error-state`**：错误状态样式
- **`.loading`**：加载状态样式
- **`.btn-small`**：小尺寸按钮

## 📝 使用流程

### 用户视角：

1. **打开AI网站**
   - 在浏览器中打开想要配置的AI网站（如ChatGPT、Gemini等）
   - 可以打开多个不同的AI网站

2. **打开配置向导**
   - 点击插件图标
   - 选择"🎯 配置AI选择器"

3. **选择要配置的网站**
   - 页面自动显示所有已打开的网站
   - 点击想要配置的网站卡片
   - 卡片会高亮显示（紫色渐变背景）

4. **如果列表为空或不完整**
   - 切换到AI网站标签页（确保它已打开）
   - 返回配置页面
   - 点击"🔄 刷新列表"

5. **继续配置流程**
   - 点击"下一步：标记元素"
   - 按照向导完成配置

## 🔧 技术细节

### 1. 配置存储

**存储格式**：
```javascript
{
  aiSelectorConfigs: {
    'chat_openai_com': {
      id: 'chat_openai_com',
      name: 'ChatGPT',
      url: 'https://chat.openai.com/',
      hostname: 'chat.openai.com',
      inputSelector: '#prompt-textarea',
      sendButtonSelector: 'button[data-testid="send-button"]'
    },
    'gemini_google_com': {
      id: 'gemini_google_com',
      name: 'Gemini',
      url: 'https://gemini.google.com/',
      hostname: 'gemini.google.com',
      inputSelector: '.ql-editor',
      sendButtonSelector: 'button[aria-label*="Send"]'
    }
    // ... 更多配置
  }
}
```

**优势**：
- 基于hostname的key，避免重复
- 支持任意数量的网站
- 配置持久化保存

### 2. 标签页选择器

**打开并标记按钮**：
```javascript
document.getElementById('openAndMark').addEventListener('click', async () => {
  if (selectedSite.tabId) {
    // 激活已存在的标签页
    await chrome.tabs.update(selectedSite.tabId, { active: true });
    await chrome.windows.update(tab.windowId, { focused: true });
  } else {
    // 打开新标签页
    const tab = await chrome.tabs.create({ url: selectedSite.url });
  }
  
  // 注入element-picker脚本
  await chrome.scripting.executeScript({
    target: { tabId: tab.id },
    files: ['selector-config/element-picker.js']
  });
});
```

### 3. 实时状态更新

监听来自element-picker的消息：
```javascript
chrome.runtime.onMessage.addListener((message) => {
  if (message.action === 'selectorSelected') {
    if (message.type === 'input') {
      currentConfig.inputSelector = message.selector;
      updatePreview();
    } else if (message.type === 'send') {
      currentConfig.sendButtonSelector = message.selector;
      updatePreview();
      enableNextStep();
    }
  }
});
```

## 🚀 优势

### 1. 完全灵活
- ✅ 支持任意网站，不限于预设列表
- ✅ 可以配置小众AI、企业内部AI等
- ✅ 甚至可以配置非AI网站（如表单填写工具）

### 2. 用户友好
- ✅ 可视化显示所有可配置的网站
- ✅ 清晰的配置状态（已配置/待配置）
- ✅ 实时刷新功能

### 3. 智能识别
- ✅ 自动识别知名AI网站并显示对应图标
- ✅ 提取标签页标题作为网站名称
- ✅ 基于hostname生成稳定的ID

### 4. 技术优势
- ✅ 使用Chrome Tabs API，可靠且高效
- ✅ 配置基于hostname，跨路径有效
- ✅ 存储在local storage，持久化

## 🧪 测试步骤

1. **打开多个AI网站**
   - 打开ChatGPT标签页
   - 打开Gemini标签页
   - 打开Claude标签页

2. **打开配置向导**
   - 点击扩展图标 → "🎯 配置AI选择器"

3. **验证列表**
   - ✅ 应该看到3个（或更多）网站卡片
   - ✅ 每个卡片显示正确的名称、URL和图标
   - ✅ 未配置的显示"待配置"

4. **测试刷新**
   - 打开一个新的AI网站标签页
   - 回到配置页面
   - 点击"🔄 刷新列表"
   - ✅ 新网站应该出现在列表中

5. **测试配置流程**
   - 选择一个网站卡片
   - ✅ 卡片应该高亮
   - 点击"下一步：标记元素"
   - ✅ 应该进入步骤2

6. **测试空状态**
   - 关闭所有AI网站标签页
   - 刷新配置页面
   - ✅ 应该显示空状态提示

## 📊 对比

| 特性 | 之前（硬编码） | 现在（动态获取） |
|------|--------------|----------------|
| 网站数量 | 6个固定 | 无限制 |
| 添加新网站 | 需要修改代码 | 直接打开标签页 |
| 小众AI | 不支持 | 完全支持 |
| 企业AI | 不支持 | 完全支持 |
| 用户体验 | 受限 | 灵活 |
| 维护成本 | 需要更新代码 | 无需维护 |

## 🎉 总结

这次改进彻底解决了硬编码的问题，使插件真正成为一个**通用的**AI聚合工具：

1. ✅ **用户自由度最大化** - 可以配置任何网站
2. ✅ **零维护成本** - 不需要预设网站列表
3. ✅ **智能且友好** - 自动识别、实时刷新
4. ✅ **技术可靠** - 使用标准Chrome API

现在用户可以：
- 配置任何AI聊天网站
- 配置企业内部的AI工具
- 配置其他需要批量输入的网站
- 随时添加/删除配置，完全自主控制

