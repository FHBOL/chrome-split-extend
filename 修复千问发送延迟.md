# 修复千问发送延迟问题

## 问题现象

**症状**：使用统一输入功能时，千问网站无法正常发送消息
**原因**：千问网站需要更长的处理时间，默认600ms的延迟不足

## 修复方案（与并发冲突的最终组合）

### 已实现的修复

在`iframe-injector.js`中添加了针对千问网站的特殊处理：
1. 识别千问网站（检测URL中是否包含"qwen"）
2. 启用“就绪等待≤2s”：等待输入内容稳定且附近发送按钮可用
3. 最小发送间隔：Qwen 专用2s（其它站点依旧保持更短）
4. Qwen 专用：仅用回车发送 + 发送互斥锁，避免按钮点击触发并发
5. 回车前触发 compositionend + input，确保中文输入法合成提交

```javascript
// Qwen: 最小间隔2s + 就绪等待（最多2s）
const minInterval = hostname.includes('qwen') ? 2000 : MIN_SEND_INTERVAL;
const timeoutMs = hostname.includes('qwen') ? 2000 : 600;
await waitUntilReadyForSend(inputElement, text, timeoutMs);
// Qwen: 仅回车发送 + 互斥锁 + 触发compositionend
```

## 原因分析

千问网站在输入文本后需要更长的处理时间才能激活发送按钮。默认的600ms延迟对大多数网站足够，但对千问来说太短，导致：
1. 发送按钮尚未激活就尝试点击
2. 输入框内容尚未完全处理
3. 网站的事件处理器尚未完全执行；且按钮点击容易触发“新建会话/登录”等无关操作，改为回车更稳定

## 验证方法

可以通过以下方法验证修复是否成功：

1. 打开分屏页面，确保包含千问网站
2. 在统一输入框中输入消息并发送
3. 观察千问iframe中的控制台日志：
   - 应该显示`⏱️ 等待2000ms后发送消息...`
   - 2秒后应该显示发送按钮相关日志

## 其他网站的处理

其他网站仍然使用默认的600ms延迟，这个值经过测试对大多数网站都足够。如果将来发现其他网站也需要特殊处理，可以采用类似的方法：

```javascript
const waitTime = hostname.includes('qwen') ? 2000 : 
                hostname.includes('other-slow-site') ? 1500 : 
                600;
```

## 后续优化

未来可能的优化方向：
1. 将延迟时间作为网站配置的一部分保存
2. 添加自适应延迟机制，根据网站响应时间动态调整
3. 实现更智能的按钮状态检测，等待按钮真正可点击（已实现“附近按钮优先+无关按钮过滤”）

---

最后更新：2025-10-21（最终方案）
