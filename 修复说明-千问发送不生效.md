# 千问发送不生效问题修复说明

## 问题原因

1. **iframe-injector.js使用硬编码选择器**：之前的代码只支持ChatGPT、Gemini、Claude三个网站，没有读取用户配置的选择器
2. **配置键名不一致**：保存配置时用的键名和读取时匹配的键名格式不统一

## 已完成的修复

### 1. 修改了 `content-scripts/iframe-injector.js`
- ✅ 页面加载时从`chrome.storage.local`读取配置
- ✅ 优先使用配置中的选择器（`inputSelector`和`sendButtonSelector`）
- ✅ 如果配置不存在或失效，回退到通用选择器列表
- ✅ 增加了详细的console.log便于调试

### 2. 修改了 `selector-config/selector-config.js`
- ✅ 自动规范化配置键名（统一为`hostname`格式，如`chat_qwen_ai`）
- ✅ 支持旧格式自动迁移

## 如何测试修复是否生效

### 步骤1: 重新加载扩展
1. 打开 `chrome://extensions/`
2. 找到"多AI对话聚合器"扩展
3. 点击刷新按钮 🔄

### 步骤2: 验证千问配置
1. 打开"选择器配置向导"
2. 检查下方"已配置的AI网站"中千问的选择器是否正确：
   - 输入框应该是：`#chat-input`
   - 发送按钮：请检查是否正确（`#open-omni-button`可能不对）

### 步骤3: 重新打开分屏视图
1. 关闭当前的分屏标签页
2. 从"标签页选择器"重新选择ChatGPT、Gemini、Qwen
3. 点击"开始分屏"

### 步骤4: 测试统一发送
1. 在分屏视图的统一输入框中输入测试消息
2. 点击"发送"按钮
3. 打开浏览器控制台（F12），查看千问iframe的日志：
   ```
   AI聚合器 - iframe注入脚本已加载
   当前hostname: chat.qwen.ai
   已加载网站配置: {inputSelector: "...", sendButtonSelector: "..."}
   收到来自父页面的消息: ...
   使用配置的输入框选择器: ...
   ```

### 步骤5: 如果还不行，使用调试脚本
1. 在千问的iframe中打开控制台
2. 将`debug-selectors.js`的内容粘贴到控制台运行
3. 执行：
   ```javascript
   findAllButtons();  // 查找所有可能的发送按钮
   testQwenFillAndSend();  // 测试完整流程
   ```

## 可能的问题和解决方案

### 问题1: 发送按钮选择器不对
**症状**：能填充文本，但不会自动发送

**解决**：
1. 在千问页面手动输入一些文字，让发送按钮显示出来
2. 在控制台运行：`findAllButtons()`
3. 找到正确的发送按钮选择器
4. 回到"选择器配置向导"重新配置千问的发送按钮

### 问题2: 配置没有生效
**症状**：控制台显示"未找到配置，使用通用选择器"

**解决**：
1. 在控制台运行：
   ```javascript
   chrome.storage.local.get(['aiSelectorConfigs'], (r) => console.log(r))
   ```
2. 检查是否有`chat_qwen_ai`的配置
3. 如果没有，说明配置键名不对，需要重新配置

### 问题3: 千问的输入框特殊
**症状**：文本填充不进去

**解决**：
1. 检查千问的输入框是`<textarea>`还是其他元素
2. 如果是特殊元素，需要在`iframe-injector.js`的`fillInput`函数中增加专门处理

## 千问可能的正确选择器

根据常见情况，千问的选择器可能是：

**输入框**：
- `#chat-input`
- `textarea[placeholder*="请输入"]`
- `.chat-input`

**发送按钮**：
- `button[type="submit"]`
- 包含"发送"文字的按钮
- 紫色的圆形按钮（需要检查其ID或class）

## 注意事项

1. ⚠️ 修改代码后必须重新加载扩展
2. ⚠️ 修改代码后必须刷新或重新打开分屏页面
3. ⚠️ iframe中的content script只在页面加载时注入一次
4. ⚠️ 如果千问页面已经打开，需要刷新才能重新加载content script

## 后续优化建议

1. 增加配置测试功能：在配置向导中直接测试选择器是否正确
2. 增加实时反馈：统一发送后显示哪些成功、哪些失败
3. 支持动态选择器：有些网站的选择器会变化，需要多个备选
4. 增加重试机制：发送失败后自动重试

---
最后更新：2025-10-17

