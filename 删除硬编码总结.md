# 🎯 删除所有硬编码AI网站 - 完整改造

## 📋 改造目标

彻底删除所有硬编码的AI网站列表，改为完全动态的从标签页选择机制。

## ✅ 已修改的文件

### 1. 核心配置文件

#### `config.js`
**修改前**：
```javascript
const DEFAULT_AI_SITES = [
  { id: 'chatgpt', name: 'ChatGPT', url: 'https://chatgpt.com/', ... },
  { id: 'gemini', name: 'Gemini', url: 'https://gemini.google.com/', ... },
  { id: 'claude', name: 'Claude', url: 'https://claude.ai/', ... }
];
```

**修改后**：
```javascript
// AI网站配置 - 不再硬编码，改为从标签页动态获取
const DEFAULT_AI_SITES = [];
```

### 2. 分屏视图

#### `split-view/split-view.js`
**修改**：
- ✅ 删除`getDefaultSites()`中的硬编码列表，返回空数组
- ✅ 修改`loadConfig()`，优先从`tab-selector`传递的数据加载
- ✅ 添加时间戳检查，确保数据是最近传递的

**关键代码**：
```javascript
async function loadConfig() {
  return new Promise((resolve) => {
    // 优先从tab-selector传递的数据加载
    chrome.storage.local.get(['selectedSitesForSplit', 'splitViewTimestamp'], (localResult) => {
      if (localResult.selectedSitesForSplit && 
          localResult.splitViewTimestamp && 
          (Date.now() - localResult.splitViewTimestamp < 5000)) {
        aiSites = localResult.selectedSitesForSplit;
        chrome.storage.local.remove(['selectedSitesForSplit', 'splitViewTimestamp']);
        resolve();
      } else {
        chrome.storage.sync.get(['aiSites'], (result) => {
          aiSites = (result.aiSites || []).filter(site => site.enabled);
          resolve();
        });
      }
    });
  });
}
```

### 3. 内容脚本

#### `content-scripts/injector.js`
**修改**：
- ✅ 删除`getDefaultSites()`中的硬编码，返回空数组

### 4. 主控制面板

#### `main/main.js`
**修改**：
- ✅ `loadConfig()`：不再使用`DEFAULT_AI_SITES`，直接返回空数组
- ✅ `resetConfig()`：改为清空所有配置，而不是恢复默认

**修改前**：
```javascript
function resetConfig() {
  aiSites = JSON.parse(JSON.stringify(DEFAULT_AI_SITES));
}
```

**修改后**：
```javascript
function resetConfig() {
  if (confirm('确定要清空所有配置吗？你将需要重新从标签页选择网站。')) {
    aiSites = [];
    saveConfig();
  }
}
```

### 5. 弹出窗口

#### `popup/popup.html`
**修改**：
- ✅ 主按钮改为"从标签页选择并分屏"
- ✅ 更新说明文字

**修改前**：
```html
<button id="openSplitView">🌐 分屏视图 (推荐) ✨</button>
```

**修改后**：
```html
<button id="openTabSelector">🌐 从标签页选择并分屏 (推荐) ✨</button>
```

#### `popup/popup.js`
**修改**：
- ✅ 添加`openTabSelector`事件监听器
- ✅ 打开`tab-selector/tab-selector.html`

## 🆕 新增文件

### 1. 标签页选择器

#### `tab-selector/tab-selector.html`
**功能**：
- 显示所有已打开的标签页
- 支持多选（最多4个）
- 提供刷新、全选、清除功能
- 启动分屏按钮

**特点**：
- 简洁美观的卡片式布局
- 实时计数器
- 空状态提示
- 使用提示

#### `tab-selector/tab-selector.css`
**样式特点**：
- 渐变紫色主题
- 响应式网格布局
- 平滑动画效果
- 卡片hover效果

#### `tab-selector/tab-selector.js`
**核心功能**：

1. **加载标签页**：
```javascript
async function loadTabs() {
  const tabs = await chrome.tabs.query({});
  allTabs = tabs.filter(tab => 
    tab.url && 
    (tab.url.startsWith('http://') || tab.url.startsWith('https://')) &&
    !tab.url.includes('chrome://') &&
    !tab.url.includes('chrome-extension://')
  );
  renderTabs();
}
```

2. **选择/取消选择**：
```javascript
function toggleTab(tab, card) {
  if (selectedTabs.includes(tab)) {
    selectedTabs = selectedTabs.filter(t => t !== tab);
    card.classList.remove('selected');
  } else {
    if (selectedTabs.length >= MAX_SELECTION) {
      showNotification(`最多只能选择 ${MAX_SELECTION} 个网站`, 'warning');
      return;
    }
    selectedTabs.push(tab);
    card.classList.add('selected');
  }
}
```

3. **启动分屏**：
```javascript
async function startSplitView() {
  const sites = selectedTabs.map(tab => ({
    id: url.hostname.replace(/[^a-zA-Z0-9]/g, '_'),
    name: tab.title || url.hostname,
    url: tab.url,
    hostname: url.hostname,
    enabled: true
  }));
  
  await chrome.storage.local.set({ 
    selectedSitesForSplit: sites,
    splitViewTimestamp: Date.now()
  });
  
  chrome.tabs.create({ 
    url: chrome.runtime.getURL('split-view/split-view.html')
  });
}
```

## 🔄 工作流程

### 新的用户流程：

1. **用户打开想要分屏的网站**
   - 在浏览器中打开ChatGPT、Gemini、Claude等

2. **点击扩展图标 → "从标签页选择并分屏"**
   - 打开`tab-selector`页面

3. **在标签页选择器中**
   - 看到所有已打开的网站（带favicon和标题）
   - 勾选想要分屏的网站（最多4个）
   - 可以使用"全选"、"清除"、"刷新"等功能

4. **点击"开始分屏"**
   - 数据临时保存到`chrome.storage.local`
   - 打开`split-view.html`
   - `split-view`读取临时数据并加载网站

5. **分屏页面显示选中的网站**
   - 完全动态，没有任何硬编码
   - 支持2/3/4个网站的不同布局

## 📊 数据流

```
用户打开网站
    ↓
chrome.tabs.query() 获取所有标签页
    ↓
tab-selector 显示列表
    ↓
用户选择网站
    ↓
chrome.storage.local.set({
  selectedSitesForSplit: [...],
  splitViewTimestamp: Date.now()
})
    ↓
打开 split-view.html
    ↓
split-view 读取 storage.local
    ↓
检查时间戳（5秒内有效）
    ↓
加载选中的网站到iframe
    ↓
清除临时数据
```

## ✅ 完全移除硬编码的好处

1. **完全灵活**
   - 用户可以选择任何网站，不限于AI
   - 支持小众AI、企业内部工具等

2. **零维护**
   - 不需要预设网站列表
   - 不需要为新AI添加代码

3. **用户友好**
   - 可视化选择，清晰直观
   - 实时显示favicon和标题
   - 支持刷新和重新选择

4. **技术优雅**
   - 使用标准Chrome API
   - 数据流清晰
   - 时间戳验证防止数据污染

## 🧪 测试清单

- [ ] `config.js` 中 `DEFAULT_AI_SITES` 为空数组
- [ ] `split-view.js` 中 `getDefaultSites()` 返回空数组
- [ ] `content-scripts/injector.js` 中 `getDefaultSites()` 返回空数组
- [ ] `main/main.js` 中不再使用 `DEFAULT_AI_SITES`
- [ ] popup中主按钮改为"从标签页选择并分屏"
- [ ] 点击主按钮打开`tab-selector`页面
- [ ] `tab-selector`正确显示所有标签页
- [ ] 可以选择多个标签页（最多4个）
- [ ] 点击"开始分屏"后正确跳转并加载
- [ ] `split-view`正确显示选中的网站

## 🎉 总结

通过这次全面改造，插件已经：
- ✅ **完全移除了所有硬编码**
- ✅ **实现了真正的动态选择**
- ✅ **提供了更好的用户体验**
- ✅ **使插件更加通用和灵活**

现在用户可以将**任何网站**进行分屏显示，不仅仅是AI聊天网站！

