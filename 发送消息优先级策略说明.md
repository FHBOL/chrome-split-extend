# 发送消息优先级策略说明

## 设计理念

基于AI聊天网站的通用规则：
- **Enter键** = 发送消息
- **Ctrl+Enter** = 换行

我们采用智能优先级策略，确保最大兼容性和最佳用户体验。

## 优先级策略

### 1. 用户自定义配置（最高优先级）⭐⭐⭐

如果用户通过"选择器配置向导"配置了发送按钮选择器：

```javascript
// 用户在selector-config中配置了
{
  sendButtonSelector: "button[data-testid='send-button']"
}
```

**行为**：
- ✅ 优先使用用户配置的选择器
- ✅ 如果按钮不可用，自动降级使用Enter键

**适用场景**：
- 用户对某个网站有特殊需求
- 网站结构特殊，通用选择器找不到
- 用户想明确指定发送方式

### 2. 通用选择器查找（中等优先级）⭐⭐

如果没有用户配置，尝试使用通用选择器查找发送按钮：

```javascript
// 通用选择器（按稳定性排序）
const selectors = [
  'button[data-testid*="send"]',
  'button[aria-label*="Send"]',
  'button[aria-label*="发送"]',
  'button[type="submit"]',
  // ... 更多通用选择器
];
```

**行为**：
- ✅ 尝试查找符合条件的发送按钮
- ✅ 如果找到且可用，点击发送
- ✅ 如果未找到或不可用，降级使用Enter键

**适用场景**：
- 大多数主流AI网站（ChatGPT、Gemini、Claude等）
- 有明确的发送按钮元素
- 通用选择器能成功匹配

### 3. Enter键发送（默认兜底）⭐

如果以上方式都不可用，使用Enter键发送：

```javascript
// 触发Enter键事件
element.dispatchEvent(new KeyboardEvent('keydown', {
  key: 'Enter',
  code: 'Enter',
  keyCode: 13,
  // ...
}));
```

**行为**：
- ✅ 最通用的发送方式
- ✅ 适用于几乎所有AI聊天网站
- ✅ 避免点击按钮可能导致的问题

**适用场景**：
- 新的AI网站（未配置）
- 发送按钮难以定位
- 简单直接的场景

## 特殊处理

### Grok特殊处理

Grok网站在点击发送按钮时会清空输入框，因此强制使用Enter键：

```javascript
if (hostname.includes('grok.com') || hostname.includes('x.com')) {
  // 使用Enter键而不是点击按钮
  triggerEnterKey(inputElement, text);
}
```

## 决策流程图

```
用户发送消息
    ↓
有用户自定义配置？
    ├─ 是 → 使用配置的选择器 → 按钮可用？
    │                            ├─ 是 → 点击按钮发送 ✅
    │                            └─ 否 → Enter键发送 ✅
    │
    └─ 否 → 查找通用发送按钮 → 找到可用按钮？
                            ├─ 是 → 特殊网站（Grok）？
                            │        ├─ 是 → Enter键发送 ✅
                            │        └─ 否 → 点击按钮发送 ✅
                            │
                            └─ 否 → Enter键发送 ✅
```

## 优势

### 1. 最大兼容性 🌐
- 适用于所有AI聊天网站
- Enter键是最通用的发送方式
- 新网站无需配置即可工作

### 2. 智能降级 🛡️
- 优先使用更精确的方式
- 失败时自动降级
- 确保消息能够发送

### 3. 用户可控 🎯
- 用户可以自定义任何网站
- 配置优先级最高
- 灵活应对特殊情况

### 4. 代码简洁 💡
- 统一的发送逻辑
- 清晰的优先级
- 易于维护和扩展

## 日志输出示例

### 使用用户配置
```
📌 使用配置的发送按钮选择器（优先级最高）
✅ 找到发送按钮: button
👆 准备点击发送按钮...
✅ 已触发简化点击事件
```

### 使用通用选择器
```
🔍 尝试查找发送按钮（通用选择器）...
✅ 找到发送按钮: button
   - 标签: BUTTON
   - ID: send-btn
   - Class: send-button
👆 准备点击发送按钮...
✅ 已触发简化点击事件
```

### 使用Enter键（默认）
```
🔍 尝试查找发送按钮（通用选择器）...
💡 未找到发送按钮，使用Enter键发送（推荐方式）
⌨️ 触发Enter键发送...
✅ 已触发Enter键事件序列
```

### Grok特殊处理
```
✅ 找到发送按钮: button
👆 准备点击发送按钮...
🎯 Grok特殊处理：使用Enter键而不是点击按钮
⌨️ 触发Enter键发送...
✅ 已触发Enter键事件序列
```

## 使用建议

### 对于用户

1. **首次使用新网站**：
   - 直接尝试发送，应该能自动工作
   - 如果不工作，使用"选择器配置向导"配置

2. **网站结构变化**：
   - 如果发送失败，检查控制台日志
   - 可能需要更新配置

3. **特殊需求**：
   - 想用特定的发送按钮：配置选择器
   - 想用Enter键：无需配置，删除现有配置即可

### 对于开发者

1. **添加新网站支持**：
   - 首先测试Enter键是否工作
   - 如果不工作，添加到通用选择器
   - 特殊情况添加专门处理

2. **调试发送问题**：
   - 查看控制台日志
   - 确认优先级流程
   - 检查选择器是否正确

3. **优化建议**：
   - 保持Enter键作为最通用的方式
   - 通用选择器按稳定性排序
   - 特殊处理尽量少

## 用户界面展示

### 1. 配置过程中的实时提示

当用户配置选择器时，界面会实时显示当前的发送策略：

**只配置了输入框**：
```
📌 发送方式：
⌨️ 使用Enter键发送（推荐）
你只配置了输入框，发送将使用最通用的Enter键方式。
✓ 适用于几乎所有AI网站，无需额外配置
```

**配置了发送按钮**：
```
📌 发送方式：
🖱️ 点击发送按钮
将使用你配置的发送按钮进行发送。
⚠ 如果按钮不可用，会自动降级使用Enter键
```

### 2. 已配置列表的直观展示

在"已配置的AI网站"列表中，每个网站会清晰显示：

```
ChatGPT  [✏️ 自定义]
  输入框: #prompt-textarea
  发送按钮: 未配置
  ━━━━━━━━━━━━━━━━━
  发送方式: ⌨️ Enter键发送（推荐）
```

```
Gemini  [⚙️ 预设]
  输入框: .ql-editor
  发送按钮: button[aria-label="Send"]
  ━━━━━━━━━━━━━━━━━
  发送方式: 🖱️ 点击发送按钮
```

### 3. 配置向导的优化提示

步骤3中明确标注"（可选）"：
```
步骤 3
点击"选择发送按钮"（可选）
移动到发送按钮上点击
💡 如果不选择，将使用Enter键发送（推荐）
```

## 总结

这个优先级策略实现了：
- ✅ **用户至上**：用户配置优先级最高
- ✅ **智能兼容**：自动适配大多数网站
- ✅ **通用可靠**：Enter键作为万能兜底
- ✅ **灵活扩展**：易于添加特殊处理
- ✅ **界面直观**：实时显示发送策略，用户一目了然
- ✅ **减少负担**：大多数情况只需配置输入框

现在用户可以：
1. **零配置使用新网站**：Enter键自动工作
2. **只配置输入框**：发送自动用Enter键（最常见）
3. **完整自定义**：完全控制输入和发送方式

用户界面会实时、直观地展示当前的发送策略，让用户清楚知道系统会如何工作！

---
**更新时间**: 2025-10-20  
**版本**: v2.1.0

