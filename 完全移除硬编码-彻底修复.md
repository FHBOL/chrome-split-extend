# 完全移除硬编码 - 彻底修复

## 问题根源

之前的实现中存在多处硬编码，违背了"完全动态化"的核心原则：

### 1. manifest.json 硬编码域名 ❌
```json
"content_scripts": [{
  "matches": [
    "https://chatgpt.com/*",
    "https://gemini.google.com/*",
    "https://claude.ai/*"
    // 每次添加新网站都要修改这里
  ]
}]
```

**问题**：
- 用户添加新AI网站时，content script无法注入
- 扩展性极差，需要修改代码并重新发布
- 千问等网站无法工作就是因为域名不在列表中

### 2. background.js 硬编码默认站点 ❌
```javascript
const defaultSites = [
  { id: 'chatgpt', name: 'ChatGPT', url: 'https://chatgpt.com/', ... },
  { id: 'gemini', name: 'Gemini', url: 'https://gemini.google.com/', ... }
];
```

**问题**：
- 暗示用户只能使用预设的AI网站
- 与"从标签页动态选择"的设计理念冲突

### 3. popup.js 硬编码默认站点 ❌
同样的问题

## ✅ 修复方案

### 1. manifest.json - 使用通配符
```json
"content_scripts": [{
  "matches": ["<all_urls>"],
  "js": ["content-scripts/iframe-injector.js"],
  "run_at": "document_idle",
  "all_frames": true
}]
```

**优势**：
- ✅ 支持任意网站，无需修改manifest
- ✅ 用户选择什么网站，就在什么网站注入
- ✅ 真正的完全动态化

### 2. background.js - 移除默认站点
```javascript
chrome.runtime.onInstalled.addListener((details) => {
  if (details.reason === 'install') {
    console.log('插件首次安装');
    // 不再初始化默认站点 - 完全由用户从标签页选择
    console.log('请使用"从标签页选择并分屏"功能选择要使用的AI网站');
  }
});
```

### 3. popup.js - 移除默认站点
```javascript
async function getAISites() {
  return new Promise((resolve) => {
    chrome.storage.sync.get(['aiSites'], (result) => {
      // 完全由用户从标签页选择，不提供默认站点
      resolve(result.aiSites || []);
    });
  });
}
```

### 4. 更新.cursorrules - 明确禁止硬编码
添加核心原则：
```
## 🚨 核心原则（必须遵守）

### 1. 绝对禁止硬编码
- ❌ 禁止在任何地方硬编码网站列表、域名、URL
- ❌ 禁止在manifest.json中硬编码content_scripts的matches（使用`<all_urls>`）
- ❌ 禁止在代码中硬编码选择器
- ✅ 一切配置从用户选择或存储中动态读取
- ✅ 支持用户添加任意网站
```

## 架构优势

### 完全动态化流程

1. **用户选择网站**
   ```
   标签页选择器 → 从已打开标签页动态获取 → 用户勾选
   ```

2. **配置选择器**
   ```
   选择器配置向导 → 可视化元素选择 → 保存到storage
   ```

3. **Content Script注入**
   ```
   <all_urls> → 所有iframe自动注入 → 从storage读取配置
   ```

4. **统一发送**
   ```
   postMessage → iframe接收 → 根据配置查找元素 → 填充并发送
   ```

### 与硬编码方案对比

| 方面 | 硬编码方案 | 完全动态化方案 |
|------|-----------|--------------|
| 支持的网站 | 固定3-5个 | 无限制 |
| 添加新网站 | 修改代码+重新发布 | 用户自己配置 |
| 维护成本 | 高（每个网站都要维护） | 低（通用逻辑） |
| 用户体验 | 受限 | 自由 |
| 扩展性 | 差 | 优秀 |

## 剩余的"硬编码"

以下是合理的硬编码，不影响扩展性：

### 1. 回退选择器（iframe-injector.js）
```javascript
const selectors = [
  '#prompt-textarea',  // ChatGPT常用
  '.ql-editor',        // Gemini常用
  // ... 更多通用选择器
];
```

**说明**：这是配置失效时的回退方案，不影响核心功能。

### 2. 图标映射（selector-config.js）
```javascript
const iconMap = {
  'chatgpt.com': '💬',
  'gemini.google.com': '🌟',
  // ...
};
```

**说明**：仅用于美化界面，不影响功能。未匹配的显示默认图标。

### 3. 配置键名规范化（selector-config.js）
```javascript
const hostMap = {
  'chatgpt': 'chatgpt_com',
  'gemini': 'gemini_google_com'
};
```

**说明**：用于迁移旧版本配置，不影响新用户。

## 测试验证

### 测试场景1：使用千问（之前失败）
1. ✅ 打开千问标签页
2. ✅ 在标签页选择器中选择
3. ✅ 打开分屏视图
4. ✅ 统一发送消息
5. ✅ 千问成功接收并发送

### 测试场景2：使用任意其他AI
1. ✅ 打开任意AI网站（如Poe、Perplexity、Claude等）
2. ✅ 在选择器配置向导中配置选择器
3. ✅ 加入分屏
4. ✅ 成功工作

### 测试场景3：使用自定义网站
1. ✅ 打开任意支持对话的网站
2. ✅ 配置输入框和发送按钮
3. ✅ 加入分屏
4. ✅ 统一发送生效

## 后续优化建议

### 1. 智能选择器推荐
当用户配置新网站时，可以：
- 自动扫描页面，找出可能的输入框和按钮
- 提供推荐列表让用户选择
- 降低配置门槛

### 2. 选择器库共享（可选）
- 用户可选择是否上传自己的配置到云端
- 其他用户可下载已验证的配置
- 完全匿名和可选

### 3. 选择器自动修复
- 网站更新后选择器可能失效
- 检测失败时，尝试使用通用规则自动修复
- 提示用户重新配置

## 经验教训

### 为什么会出现硬编码？

1. **开发初期的便利性**：硬编码3个网站快速验证功能
2. **逐渐增加网站**：从3个到5个、10个，没及时重构
3. **没有严格遵守设计原则**：虽然有"删除硬编码总结.md"但执行不彻底

### 如何避免？

1. **代码审查**：每次提交检查是否有新的硬编码
2. **测试用例**：测试任意网站，不只是常见的几个
3. **文档先行**：先写设计文档，明确"绝不硬编码"
4. **定期重构**：发现硬编码立即重构

## 核心价值

这次彻底移除硬编码后，扩展的核心价值得到体现：

1. **真正的通用性**：不限定AI类型，任何网站都可以
2. **用户自主性**：用户决定用什么、怎么用
3. **长期维护性**：AI网站更新不影响扩展
4. **扩展可能性**：不只是AI，任何需要统一操作的网站都适用

---

最后更新：2025-10-17
修复版本：2.0.0
关键词：完全动态化、零硬编码、通用扩展

