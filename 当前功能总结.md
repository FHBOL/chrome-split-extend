# 📊 多AI对话聚合器 - 当前功能总结

**版本**: 1.0.0  
**更新日期**: 2025-10-15

## 🎯 核心功能

### 1. 从标签页选择并分屏 🌐 (主要功能)

**入口**: 扩展图标 → "从标签页选择并分屏"

**功能描述**:
- 显示所有已打开的浏览器标签页
- 用户可以选择最多4个网站进行分屏
- 支持实时刷新标签页列表
- 提供全选、清除功能
- 选择后在一个标签页内并排显示所有网站

**技术实现**:
- 使用`chrome.tabs.query()`获取所有标签页
- 使用`chrome.storage.local`传递选择的网站数据
- 使用时间戳验证数据新鲜度（5秒内有效）
- 自动识别网站favicon和标题

**支持的网站**:
- ✅ 任意HTTP/HTTPS网站
- ✅ AI聊天网站（ChatGPT、Gemini、Claude等）
- ✅ 文档网站、工具网站等
- ❌ chrome://内部页面
- ❌ chrome-extension://扩展页面

### 2. 分屏视图 📱 (核心显示)

**技术亮点**:
- 使用`declarativeNetRequest` API移除X-Frame-Options限制
- 在一个标签页内使用iframe嵌入多个网站
- 完全保留登录状态和Cookie
- 支持网站的所有交互功能

**支持的布局**:
- 2列横向（左右分屏）
- 2列纵向（上下分屏）
- 3列横向
- 3格网格
- 4格网格

**核心特性**:
- ✅ 真正的单标签页分屏
- ✅ 保持所有网站的登录状态
- ✅ 支持iframe内的完整交互
- ✅ 统一输入框（需先配置选择器）
- ✅ 空状态友好引导

### 3. 配置AI选择器 🎯 (统一发送前提)

**入口**: 扩展图标 → "配置AI选择器"

**功能描述**:
三步向导式配置：

**步骤1**: 从已打开的标签页中选择AI网站
- 动态显示所有标签页
- 智能识别常见AI网站图标
- 支持刷新列表

**步骤2**: 可视化标记元素
- 打开AI网站并注入element-picker工具
- 鼠标悬停高亮显示元素
- 点击选择输入框和发送按钮
- 自动生成CSS选择器

**步骤3**: 测试并保存
- 测试填充和发送功能
- 保存配置到chrome.storage
- 一次配置，永久使用

**技术特点**:
- ✅ 完全可视化，无需手写CSS选择器
- ✅ 阻止元素的误触发（mousedown/mouseup/click三重阻止）
- ✅ 支持任意网站（不限于AI）
- ✅ 配置持久化保存
- ✅ 实时预览当前配置

### 4. 统一发送功能 ⚡

**前提**: 必须先配置对应网站的选择器

**工作原理**:
1. 用户在分屏视图顶部的统一输入框输入内容
2. 点击"发送"或按Enter键
3. 通过`postMessage`向所有iframe发送消息
4. iframe内的`iframe-injector.js`接收消息
5. 根据配置的选择器找到输入框和发送按钮
6. 填充内容并触发发送
7. 发送成功后自动清空输入框

**支持的交互**:
- ✅ Enter键发送
- ✅ Ctrl+Enter / Shift+Enter换行
- ✅ 发送后自动清空
- ✅ 同时向多个AI发送相同问题

**兼容性**:
- ✅ 支持textarea输入框
- ✅ 支持contentEditable编辑器
- ✅ 支持Quill编辑器（Gemini）
- ✅ 支持ProseMirror编辑器（Claude）
- ✅ 触发多种事件确保兼容性

## 🛠️ 辅助功能

### 5. 窗口管理器 🖥️ (备用方案)

**入口**: 扩展图标 → "窗口管理器"

**功能描述**:
- 从已打开的标签页中选择
- 使用`chrome.windows` API创建独立窗口
- 自动排列窗口布局
- 保持每个网站的独立性

**适用场景**:
- iframe方式无法加载某些特殊网站时
- 需要更大的显示空间时
- 偏好独立窗口的用户

### 6. 快速发送 📤

**入口**: 扩展弹出窗口底部

**功能描述**:
- 在弹出窗口中快速输入
- 发送到所有已配置的AI网站
- 无需打开分屏视图

**适用场景**:
- 快速提问
- 不需要查看回答
- 后台批量发送

## 📦 数据管理

### 存储机制

**chrome.storage.local** (临时数据):
```javascript
{
  selectedSitesForSplit: [...], // tab-selector选择的网站
  splitViewTimestamp: 1234567890, // 时间戳
  aiSelectorConfigs: {...}  // 选择器配置
}
```

**chrome.storage.sync** (持久数据):
```javascript
{
  aiSites: [...]  // 已配置的AI网站（向后兼容，现已不使用）
}
```

### 配置格式

单个网站配置:
```javascript
{
  id: 'chat_openai_com',              // 基于hostname生成
  name: 'ChatGPT',                    // 网站名称
  url: 'https://chat.openai.com/',    // 完整URL
  hostname: 'chat.openai.com',        // 域名
  inputSelector: '#prompt-textarea',   // 输入框选择器
  sendButtonSelector: 'button[data-testid="send-button"]', // 发送按钮选择器
  enabled: true                        // 是否启用
}
```

## 🔧 技术架构

### 核心技术栈

1. **Chrome Extension Manifest V3**
2. **declarativeNetRequest API** - 移除X-Frame-Options
3. **postMessage API** - 跨iframe通信
4. **Content Scripts** - DOM操作
5. **Chrome Storage API** - 数据持久化
6. **Chrome Tabs API** - 标签页管理

### 文件结构

```
多窗口插件/
├── manifest.json                 # 扩展配置
├── rules.json                   # 网络请求修改规则
├── background.js                # 后台服务
├── config.js                    # 空配置（向后兼容）
├── popup/                       # 弹出窗口
│   ├── popup.html
│   ├── popup.css
│   └── popup.js
├── tab-selector/                # 标签页选择器 ⭐
│   ├── tab-selector.html
│   ├── tab-selector.css
│   └── tab-selector.js
├── split-view/                  # 分屏视图 ⭐
│   ├── split-view.html
│   ├── split-view.css
│   └── split-view.js
├── selector-config/             # 选择器配置 ⭐
│   ├── selector-config.html
│   ├── selector-config.css
│   ├── selector-config.js
│   ├── element-picker.js        # 元素选择工具
│   └── element-picker.css
├── content-scripts/             # 内容脚本
│   ├── injector.js             # 通用注入
│   └── iframe-injector.js      # iframe内注入 ⭐
├── window-manager/              # 窗口管理器
│   ├── window-manager.html
│   ├── window-manager.css
│   └── window-manager.js
└── icons/                       # 图标资源
```

## 🎨 用户界面

### 主题颜色
- 主色调: 渐变紫色 `#667eea` → `#764ba2`
- 成功: 绿色 `#28a745`
- 警告: 黄色 `#ffc107`
- 错误: 红色 `#f56c6c`

### 设计风格
- 现代扁平化设计
- 圆角卡片式布局
- 平滑动画过渡
- 响应式网格布局

## 📈 使用流程

### 推荐流程

```
1. 打开想要对比的AI网站
   (ChatGPT、Gemini、Claude等)
   ↓
2. 点击扩展图标
   ↓
3. 选择"从标签页选择并分屏"
   ↓
4. 在列表中勾选2-4个网站
   ↓
5. 点击"开始分屏"
   ↓
6. 在统一输入框输入问题
   ↓
7. 按Enter发送到所有AI
   ↓
8. 同时查看所有AI的回答
```

### 首次使用（需配置）

```
1. 点击扩展图标
   ↓
2. 选择"配置AI选择器"
   ↓
3. 选择要配置的AI网站
   ↓
4. 可视化选择输入框和发送按钮
   ↓
5. 测试并保存
   ↓
6. 完成配置，开始使用
```

## ✅ 已解决的问题

### 技术问题

1. ✅ **iframe加载限制**
   - 使用declarativeNetRequest移除X-Frame-Options

2. ✅ **跨域通信**
   - postMessage + content script

3. ✅ **选择器误触发**
   - 三重事件阻止（mousedown/mouseup/click）

4. ✅ **输入框兼容性**
   - 支持textarea、contentEditable、Quill等

5. ✅ **数据传递**
   - 时间戳验证 + localStorage临时存储

6. ✅ **硬编码问题**
   - 完全动态化，从标签页获取

### 用户体验

1. ✅ **空状态友好**
   - 引导界面而非空白页

2. ✅ **操作反馈**
   - 加载、成功、失败都有提示

3. ✅ **灵活配置**
   - 可视化选择器，无需手写CSS

4. ✅ **实时更新**
   - 支持刷新标签页列表

## 🚧 已知限制

1. **iframe限制**
   - 某些使用强CSP的网站可能仍无法加载
   - 建议使用窗口管理器作为备选

2. **统一发送限制**
   - 需要预先配置选择器
   - 某些动态网站可能需要重新配置

3. **性能**
   - 同时加载4个AI网站可能占用较多内存
   - 建议选择2-3个网站以获得最佳性能

4. **布局**
   - 暂不支持自定义布局
   - iframe大小固定，不可拖拽调整

## 🔮 未来计划

### 短期 (v1.1)
- [ ] 支持拖拽调整iframe大小
- [ ] 添加快捷键支持
- [ ] 优化性能（懒加载iframe）
- [ ] 添加更多预设布局

### 中期 (v1.2)
- [ ] 对话历史记录
- [ ] 答案对比视图
- [ ] 导出对话功能
- [ ] 支持暗色模式

### 长期 (v2.0)
- [ ] 智能选择器自动识别
- [ ] AI回答实时对比分析
- [ ] 多设备同步配置
- [ ] 插件生态系统

## 📝 版本历史

### v1.0.0 (2025-10-15)
- ✅ 完全移除硬编码AI列表
- ✅ 实现从标签页动态选择
- ✅ 使用declarativeNetRequest突破iframe限制
- ✅ 实现跨iframe统一发送
- ✅ 可视化选择器配置
- ✅ 空状态友好引导
- ✅ Enter发送，发送后自动清空

## 🎉 总结

这个插件实现了：
1. **真正的单标签页分屏** - 使用iframe + declarativeNetRequest
2. **完全灵活的网站选择** - 无硬编码，动态从标签页获取
3. **统一输入发送** - postMessage + content script
4. **可视化配置** - 无需手写代码
5. **友好的用户体验** - 引导、提示、反馈完整

**技术突破**: declarativeNetRequest绕过X-Frame-Options是关键
**用户价值**: 一个标签页同时对比多个AI的回答
**灵活性**: 支持任意网站，不限于AI

---

如需更详细的技术文档，请查看 `.cursorrules` 文件。

