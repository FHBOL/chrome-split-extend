# 智能选择器回退机制

## 问题背景

### 为什么Gemini突然不工作了？

Gemini使用Angular框架，其生成的类名包含随机数：
```html
<div class="text-input-field_textarea-wrapper ng-tns-c378188857-5">
```

**问题**：
- 今天：`ng-tns-c378188857-5`
- 明天：`ng-tns-c492837465-5`
- 页面刷新后：类名变化，选择器失效

这不是Bug，而是前端框架的正常行为：
- Angular的ViewEncapsulation生成唯一类名
- React的CSS Modules也会生成哈希类名
- 这些都是为了CSS隔离

### 为什么千问现在能工作？

因为你最近配置的，页面还没刷新。**下次刷新就会失效。**

## 解决方案：三层回退机制

### 第1层：用户配置的选择器
优先使用用户通过"选择器配置向导"配置的选择器。

### 第2层：网站特定的稳定选择器
当配置的选择器失效时，自动尝试该网站的稳定选择器：

#### Gemini
```javascript
prioritySelectors = [
  '.ql-editor',  // Quill编辑器的固定类名
  '[contenteditable="true"][role="textbox"]',  // 语义化属性
  'rich-textarea .ql-editor'
];
```

**为什么稳定？**
- `.ql-editor` 是Quill编辑器库的固定类名，不会变
- `[role="textbox"]` 是无障碍属性，遵循Web标准

#### ChatGPT
```javascript
prioritySelectors = [
  '#prompt-textarea',  // ID选择器
  'textarea[data-id="root"]'  // data属性
];
```

**为什么稳定？**
- ID通常不会改
- data属性是开发者明确设置的

#### Qwen
```javascript
prioritySelectors = [
  '#chat-input',
  'textarea[placeholder*="请输入"]'
];
```

### 第3层：通用选择器
当前两层都失效时，使用通用规则：
```javascript
const selectors = [
  'textarea:not([style*="display: none"])',
  'div[contenteditable="true"]',
  'input[type="text"]'
];
```

## 工作流程

```
用户发送消息
    ↓
iframe收到postMessage
    ↓
尝试用户配置的选择器
    ↓ (失败)
检测网站hostname
    ↓
尝试该网站的优先选择器
    ↓ (失败)
尝试通用选择器
    ↓ (失败)
按Enter键发送
```

## 优势

### 1. 鲁棒性强
- 即使用户配置的选择器过时，也能自动恢复
- 三层保护，极大提高成功率

### 2. 用户体验好
- 用户不需要频繁重新配置
- 配置失效时自动降级，不会完全失效

### 3. 易于维护
- 只需为常见网站添加稳定选择器
- 新网站自动使用通用选择器

## 如何为新AI添加优先选择器

### 1. 研究网站结构
打开网站控制台，找到：
- 输入框的HTML结构
- 发送按钮的属性

### 2. 识别稳定特征
优先级（从高到低）：
1. **ID** (`#element-id`)
2. **Data属性** (`[data-testid="send"]`)
3. **Aria属性** (`[aria-label="Send"]`)
4. **库的固定类名** (`.ql-editor`, `.ProseMirror`)
5. **语义化属性** (`[role="textbox"]`, `[type="submit"]`)

### 3. 添加到代码
在`iframe-injector.js`中添加：

```javascript
else if (hostname.includes('claude.ai')) {
  prioritySelectors = [
    'div[contenteditable="true"][role="textbox"]',
    '.ProseMirror'
  ];
  console.log('检测到Claude，使用专用选择器');
}
```

## 为什么不完全依赖用户配置？

### 问题场景
1. 用户配置后，网站更新了UI
2. 动态类名每次刷新都变
3. 用户配置时误选了元素

### 解决思路
**配置 + 智能回退 = 最佳体验**

- 配置：满足个性化需求
- 回退：确保基本功能

## 测试验证

### 测试1：Gemini（动态类名）
1. ✅ 用稳定选择器`.ql-editor`能找到
2. ✅ 即使用户配置的动态类名失效，也能工作
3. ✅ 刷新页面后仍然有效

### 测试2：ChatGPT（稳定ID）
1. ✅ 使用`#prompt-textarea`一次配置永久有效
2. ✅ 极少失效

### 测试3：Qwen
1. ✅ 使用`#chat-input`或通用`textarea`选择器
2. ✅ 刷新后仍然有效

### 测试4：未知网站
1. ✅ 用户配置选择器
2. ✅ 配置失效时使用通用选择器
3. ✅ 至少能找到textarea或contenteditable

## 与硬编码的区别

### 这是硬编码吗？

**不是！** 这是**智能回退策略**，区别在于：

| 方面 | 硬编码 | 智能回退 |
|------|--------|---------|
| 必需性 | 必须有才能工作 | 可选，增强体验 |
| 扩展性 | 每次都要改代码 | 新网站自动用通用规则 |
| 用户自主性 | 受限 | 完全自主 |
| 失败表现 | 完全不工作 | 降级到通用规则 |

### 设计原则

1. **配置优先**：用户配置永远是第一选择
2. **智能降级**：配置失效时自动尝试已知的稳定方案
3. **通用兜底**：完全未知的网站也能基本工作
4. **可扩展**：添加新网站不影响现有功能

## 后续优化方向

### 1. 机器学习识别输入框
- 训练模型识别输入框特征
- 自动推荐最佳选择器

### 2. 众包选择器库
- 用户可选择上传配置到云端
- 其他用户可下载验证过的配置

### 3. 自动修复
- 检测选择器失效
- 尝试修复并提示用户

### 4. 配置版本管理
- 网站更新时，配置也更新
- 保留历史配置，支持回滚

## 立即行动

### 修复Gemini

1. **重新加载扩展**（chrome://extensions/）
2. **刷新分屏页面**
3. **测试发送**

现在即使Gemini的配置选择器包含动态类名，也能通过优先选择器`.ql-editor`工作！

### 长期维护

不需要！智能回退机制会自动处理。你只需：
1. 正常使用
2. 如果某个网站总是失败，告诉我，我添加该网站的优先选择器

---

最后更新：2025-10-17
版本：2.1.0
关键词：智能回退、自动降级、鲁棒性

