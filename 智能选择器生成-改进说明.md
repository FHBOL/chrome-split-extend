# 智能选择器生成 - 改进说明

## 问题诊断

### 你遇到的问题
即使你点击了**正确的发送按钮**，生成的选择器仍然是 `span.mat-mdc-button-touch-target`，这个选择器会匹配到多个按钮（包括侧边栏按钮），导致误触发。

### 根本原因
旧的 `generateSelector` 函数太简单：
1. 检查ID → 没有
2. 检查几个属性 → 没找到合适的
3. **直接使用所有class** → 包括通用的Material Design类 ❌

这导致生成的选择器不够精确。

## 解决方案：智能选择器生成

### 改进后的策略

#### 优先级排序（从高到低）

1. **ID选择器** (`#element-id`)
   - 最稳定，唯一性强
   
2. **语义化属性**
   - `data-testid` - 测试ID，最稳定
   - `aria-label` - 无障碍标签（如"Send message"）
   - `type="submit"` - 表单提交按钮
   - `name`, `placeholder`, `role`

3. **智能class过滤**
   - ✅ **保留**：有语义的类名（如 `send-button`, `chat-input`）
   - ❌ **排除**：
     - Material Design通用类（`mat-*`, `mdc-*`）
     - Angular动态类（`ng-*`）
     - 样式工具类（`flex`, `m-4`, `text-blue`）
     - 包含大量数字的随机类

4. **父元素+nth-child**
   - 当class也不可靠时使用

5. **兜底：标签名**
   - 最后的选择，但不够精确

### 具体改进

#### 改进1：过滤通用框架类名

```javascript
// ❌ 旧逻辑：使用所有class
const classes = element.className.split(' ');
return `button.${classes.join('.')}`;
// 结果: button.mat-mdc-button.mat-primary.mat-button-base
// 问题: 太通用，匹配多个按钮

// ✅ 新逻辑：过滤无用class
const classes = element.className.split(' ').filter(c => {
  // 排除mat-*, mdc-*, ng-*等
  if (c.startsWith('mat-') || c.startsWith('mdc-')) return false;
  if (c.match(/^ng-/)) return false;
  if (c.match(/[0-9]{5,}/)) return false; // 排除随机数字
  return true;
});
```

#### 改进2：优先使用语义化属性

```javascript
// 如果按钮有aria-label="Send message"
// ✅ 生成: button[aria-label*="Send"]
// 而不是使用通用的class

// 如果按钮有type="submit"
// ✅ 生成: button[type="submit"]
```

#### 改进3：智能选择有意义的类名

```javascript
// 如果元素有多个class: ['send-button', 'primary', 'mat-button']
// ✅ 优先使用: button.send-button
// 因为'send-button'包含语义信息
```

## 效果对比

### 场景1：Gemini的发送按钮

#### 旧方案：
```html
<button class="mat-mdc-button mat-primary">
  <span class="mat-mdc-button-touch-target"></span>
</button>
```
**生成选择器**：`span.mat-mdc-button-touch-target` ❌
**问题**：页面上很多按钮都有这个span

#### 新方案：
```html
<button aria-label="Send message" type="button">
  <span class="mat-mdc-button-touch-target"></span>
</button>
```
**生成选择器**：`button[aria-label*="Send"]` ✅
**优势**：精确匹配发送按钮，不会误触其他按钮

### 场景2：Qwen的发送按钮

#### 旧方案：
```html
<button class="ant-btn ant-btn-primary" type="submit">发送</button>
```
**生成选择器**：`button.ant-btn.ant-btn-primary` ❌
**问题**：其他主要按钮也用这些class

#### 新方案：
```html
<button class="ant-btn ant-btn-primary" type="submit">发送</button>
```
**生成选择器**：`button[type="submit"]` ✅
**优势**：submit类型明确表示这是提交按钮

### 场景3：自定义网站

#### 假设HTML：
```html
<button class="flex items-center justify-center send-btn bg-blue-500">
  Send
</button>
```

#### 旧方案：
**生成选择器**：`button.flex.items-center.justify-center` ❌
**问题**：这些是Tailwind工具类，很多元素都有

#### 新方案：
**生成选择器**：`button.send-btn` ✅
**优势**：`send-btn`是有语义的类名，更精确

## 使用说明

### 重新配置所有AI

1. **重新加载扩展**（chrome://extensions/ → 刷新）
2. **删除旧配置**：
   - 打开"选择器配置向导"
   - 在"已配置的AI网站"中删除所有配置
3. **重新配置**：
   - 选择Gemini → 打开并标记 → 点击正确的元素
   - 选择ChatGPT → 打开并标记 → 点击正确的元素
   - 选择Qwen → 打开并标记 → 点击正确的元素

### 验证选择器

配置完成后，在配置页面的控制台查看：
```
生成选择器，元素: <button>
使用aria-label部分匹配: Send message
```

如果看到：
- ✅ `使用aria-label` / `使用data-testid` / `使用type属性` - 很好！
- ⚠️ `使用有语义的class` - 还可以
- ❌ `只能使用标签名` - 需要手动调整

## 为什么这次会更好？

### 根本性改进

1. **不再依赖框架类名**
   - Material Design, Ant Design等框架的通用类被过滤
   - 只保留有意义的自定义类名

2. **优先使用Web标准**
   - `aria-label` - W3C无障碍标准
   - `type="submit"` - HTML标准
   - `data-testid` - 测试最佳实践

3. **智能判断**
   - 自动识别有意义的类名（包含send、button、chat等）
   - 过滤样式工具类（flex、grid、m-4等）
   - 排除随机生成的类名

### 长期稳定性

#### 为什么aria-label稳定？
- 无障碍（Accessibility）是Google、OpenAI等大公司的重要标准
- aria-label改变会影响屏幕阅读器，不会轻易修改
- 即使UI改版，aria-label通常保持不变

#### 为什么type="submit"稳定？
- HTML标准，表单语义化
- 改变type会影响表单行为，开发者不会轻易改

#### 为什么data-testid稳定？
- 自动化测试依赖这些ID
- 改变会导致测试失败，所以很稳定

## 仍然可能遇到的问题

### 问题1：网站完全不遵循标准
**症状**：按钮没有aria-label、没有type、class全是随机字符
**解决**：手动在控制台运行诊断脚本，找到最合适的选择器

### 问题2：选择器仍然不够精确
**症状**：多个按钮匹配同一个选择器
**解决**：使用更具体的选择器，如组合选择器：
```css
form button[type="submit"]
.chat-input-container button[aria-label*="Send"]
```

## 立即行动

1. **重新加载扩展**
2. **删除所有旧配置**
3. **重新配置Gemini、ChatGPT、Qwen**
4. **查看控制台日志，确认生成了好的选择器**
5. **测试统一发送**

现在生成的选择器应该是：
- Gemini: `button[aria-label*="Send"]`
- ChatGPT: `button[data-testid="send-button"]` 或 `#prompt-textarea`
- Qwen: `button[type="submit"]` 或类似的稳定选择器

不再是 `span.mat-mdc-button-touch-target` 这种通用的选择器了！

---

最后更新：2025-10-17
版本：3.1.0 - 智能选择器生成
关键词：选择器生成、过滤框架类、语义化属性、稳定性

