# 统一发送功能使用说明

## 🎯 功能实现原理

### 技术方案

由于iframe的跨域限制，我们采用**双重方案**确保消息能够发送：

1. **postMessage通信**
   - 父页面通过`postMessage`发送消息到iframe
   - iframe内的content script监听消息
   - 执行填充和发送操作

2. **all_frames注入**
   - Content script设置为`all_frames: true`
   - 自动注入到所有iframe中
   - 监听postMessage事件

### 关键配置

#### manifest.json
```json
"content_scripts": [
  {
    "matches": [...],
    "js": ["content-scripts/injector.js", "content-scripts/iframe-injector.js"],
    "run_at": "document_idle",
    "all_frames": true  // 关键：注入到所有frame
  }
]
```

#### iframe-injector.js
- 监听`window.addEventListener('message')`
- 验证消息来源：`event.data.source === 'ai-aggregator'`
- 查找输入框和发送按钮
- 执行填充和点击操作

## 📝 使用步骤

### 1. 重新加载插件

**重要！** 修改后需要重新加载：

1. 打开 `chrome://extensions/`
2. 找到"多AI对话聚合器"
3. 点击刷新按钮 🔄

### 2. 打开分屏视图

1. 点击插件图标
2. 选择"🌐 分屏视图 (推荐) ✨"

### 3. 等待AI网站加载

- ChatGPT、Gemini、Claude会在iframe中加载
- 首次需要在每个iframe中登录
- 登录后状态会保持

### 4. 测试统一发送

1. **在顶部输入框输入问题**
   ```
   例如：解释量子计算的基本原理
   ```

2. **点击"⚡ 发送"按钮**

3. **观察效果**
   - 应该看到所有AI的输入框都被填充
   - 消息自动发送
   - 可以同时看到所有AI的回答

### 5. 调试方法

如果统一发送不工作，按F12打开开发者工具：

**在父页面（分屏视图）的控制台：**
```javascript
// 应该看到这些日志
已向iframe 0 发送消息
已向iframe 1 发送消息
已向iframe 2 发送消息
```

**在iframe内的控制台：**
```javascript
// 切换到iframe的context（控制台顶部下拉菜单）
// 应该看到这些日志
AI聚合器 - iframe注入脚本已加载
检测到网站: chatgpt
收到来自父页面的消息: {action: "fillAndSend", text: "...", source: "ai-aggregator"}
开始填充消息: ...
找到输入框: <textarea>
找到发送按钮，准备点击
已点击发送按钮
```

## 🔧 故障排除

### 问题1: 点击发送后没反应

**可能原因：**
- Content script未注入到iframe
- iframe还未完全加载
- AI网站未登录

**解决方法：**
1. 检查控制台是否有"iframe注入脚本已加载"日志
2. 等待iframe完全加载（显示输入框）
3. 确保已在iframe中登录
4. 重新加载插件

### 问题2: 只有部分AI收到消息

**可能原因：**
- 某些AI的输入框选择器不匹配
- 某些iframe加载失败

**解决方法：**
1. 检查控制台错误日志
2. 手动在该AI的iframe中输入测试
3. 查看是否有iframe加载错误

### 问题3: 消息填充了但没发送

**可能原因：**
- 发送按钮选择器不匹配
- 发送按钮被禁用

**解决方法：**
1. 查看控制台日志
2. 如果显示"未找到发送按钮，尝试按Enter键"
3. 手动测试：在输入框输入内容后按Enter是否能发送
4. 如果可以，说明Enter键方案生效

### 问题4: ChatGPT发送失败

**ChatGPT特殊处理：**

ChatGPT的输入框和发送逻辑比较复杂，可能需要特殊处理。

**调试代码：**
```javascript
// 在ChatGPT iframe的控制台运行
const textarea = document.querySelector('#prompt-textarea');
console.log('输入框:', textarea);

const button = document.querySelector('button[data-testid="send-button"]');
console.log('发送按钮:', button);

// 测试填充
textarea.value = '测试消息';
textarea.dispatchEvent(new Event('input', { bubbles: true }));

// 测试点击
button.click();
```

## 💡 优化建议

### 1. 确保iframe完全加载

在发送前可以等待几秒，确保所有iframe都已加载：

```javascript
// 手动操作建议
1. 打开分屏视图
2. 等待3-5秒，确保所有iframe加载完成
3. 然后再使用统一发送
```

### 2. 分批发送

如果同时发送到多个AI不稳定，可以：

1. 先发送到2个AI测试
2. 成功后再尝试3-4个

### 3. 手动备份方案

如果统一发送不工作，可以：

1. 在顶部输入框输入问题
2. 复制文本（Ctrl+C）
3. 手动点击每个iframe
4. 粘贴并发送

## 📊 预期效果

### 成功状态

```
1. 在顶部输入："什么是人工智能？"
2. 点击"⚡ 发送"
3. 观察：

┌─────────────────────────────────────┐
│ ChatGPT: 输入框自动填充 → 自动发送  │
│ "什么是人工智能？"                   │
│ AI开始回答...                        │
├─────────────────────────────────────┤
│ Gemini: 输入框自动填充 → 自动发送   │
│ "什么是人工智能？"                   │
│ AI开始回答...                        │
├─────────────────────────────────────┤
│ Claude: 输入框自动填充 → 自动发送   │
│ "什么是人工智能？"                   │
│ AI开始回答...                        │
└─────────────────────────────────────┘

✅ 所有AI同时回答，可以直接对比！
```

## 🎯 下一步

如果统一发送功能正常工作：

1. ✅ 享受真正的分屏对比体验
2. ✅ 一次输入，多个AI同时回答
3. ✅ 实时对比不同AI的回答质量
4. ✅ 提高工作效率

如果仍有问题：

1. 提供控制台日志截图
2. 说明具体是哪个AI不工作
3. 我们会进一步优化选择器

---

**祝使用愉快！** 🎉

